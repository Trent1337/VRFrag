<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VRFrag · Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#242834;
      --bg2:#1f2230;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#f2f5ff;
      --muted: rgba(242,245,255,.72);
      --primary:#2f9bff;
      --primary2:#3a7cff;
      --danger:#ef4444;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
      --ring:rgba(47,155,255,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;
      padding:22px;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(47,155,255,.25), transparent 55%),
        radial-gradient(900px 420px at 85% 10%, rgba(124,58,237,.22), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }
    .wrap{max-width:1200px;margin:0 auto}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom:16px;
      gap:12px;
    }
    .leftHead{display:flex;align-items:center;gap:12px}
    .back-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      text-decoration:none;
      font-weight:800;
    }
    .back-btn:hover{background:rgba(255,255,255,.08)}
    h1{font-size:1.05rem;margin:0}
    .crumbs{color:var(--muted);font-size:.9rem;white-space:nowrap}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 14px 0 16px 0;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:10px 14px;
      border-radius: 999px;
      font-weight: 850;
      cursor:pointer;
    }
    .tab.active{
      border-color: transparent;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 16px 35px rgba(47,155,255,.18);
    }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media(max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .hd h2{margin:0;font-size:1rem}
    .bd{padding:16px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border:1px solid var(--border);
      border-radius:999px;color:var(--muted);font-size:.85rem;
      background:rgba(255,255,255,.05);
      white-space:nowrap;
    }

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media(max-width: 520px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:12px 12px;
    }
    .kpi .label{color:var(--muted);font-size:.9rem;font-weight:750}
    .kpi .value{font-size:1.65rem;font-weight:900;margin-top:6px}

    label{display:block;font-size:.9rem;color:rgba(242,245,255,.9);margin-bottom:8px;font-weight:800}
    select{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    select:focus{box-shadow:0 0 0 4px var(--ring); border-color: rgba(47,155,255,.55);}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    thead th{
      text-align:left;
      font-size:.9rem;
      padding:10px 10px;
      background: rgba(0,0,0,.35);
      border-bottom:1px solid var(--border);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: rgba(242,245,255,.92);
    }
    tbody tr:hover{background: rgba(255,255,255,.04)}
    .rank{
      width:42px;
      color: rgba(242,245,255,.85);
      font-weight:900;
    }
    .top3{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px;
    }
    @media(max-width: 700px){ .top3{grid-template-columns:1fr} }
    .pod{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:12px 12px;
      position:relative;
      overflow:hidden;
    }
    .pod .pos{
      position:absolute; top:10px; right:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      border-radius: 999px;
      padding:6px 10px;
      font-weight:950;
      color: rgba(242,245,255,.9);
    }
    .pod .name{font-weight:950;font-size:1.05rem}
    .pod .metric{margin-top:6px;color:var(--muted);font-weight:800}
    .pod.gold{border-left:4px solid #fcd712}
    .pod.silver{border-left:4px solid rgba(242,245,255,.55)}
    .pod.bronze{border-left:4px solid rgba(255,170,90,.75)}

    .charts{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width: 980px){ .charts{grid-template-columns:1fr} }
    .chartBox{border:1px solid var(--border);border-radius:16px;background:rgba(0,0,0,.18);padding:12px}
    .chartTitle{font-weight:900;margin:0 0 8px 0;color:rgba(242,245,255,.9)}
    .muted{color:var(--muted)}
    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="leftHead">
        <a href="/" class="back-btn">← Zurück</a>
        <div>
          <h1>Dashboard</h1>
          <div class="crumbs">VRFrag · PowerBI-Style</div>
        </div>
      </div>
      <span class="pill" id="data-pill">Daten: lädt…</span>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="tab-leaderboard">Leaderboard</button>
      <button class="tab" data-tab="tab-player">Player Stats</button>
      <button class="tab" data-tab="tab-auswertung">Auswertung</button>
    </div>

    <!-- LEADERBOARD -->
    <section id="tab-leaderboard">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Avg. Kills</h2>
            <span class="pill">Top-Liste</span>
          </div>
          <div class="bd">
            <div class="top3" id="top3-avgkills"></div>
            <div class="muted" style="margin-bottom:10px;font-weight:800">Gesamtrangliste</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th class="rank">#</th><th>Spieler</th><th>Avg. Kills</th></tr></thead>
                <tbody id="tbl-avgkills"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Score</h2>
            <span class="pill">Top-Liste</span>
          </div>
          <div class="bd">
            <div class="top3" id="top3-score"></div>
            <div class="muted" style="margin-bottom:10px;font-weight:800">Gesamtrangliste</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th class="rank">#</th><th>Spieler</th><th>Score</th></tr></thead>
                <tbody id="tbl-score"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>Total Kills</h2>
            <span class="pill">Top-Liste</span>
          </div>
          <div class="bd">
            <div class="top3" id="top3-totalkills"></div>
            <div class="muted" style="margin-bottom:10px;font-weight:800">Gesamtrangliste</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th class="rank">#</th><th>Spieler</th><th>Total Kills</th></tr></thead>
                <tbody id="tbl-totalkills"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>MVP</h2>
            <span class="pill">Top-Liste</span>
          </div>
          <div class="bd">
            <div class="top3" id="top3-mvp"></div>
            <div class="muted" style="margin-bottom:10px;font-weight:800">Gesamtrangliste</div>
            <div style="overflow:auto">
              <table>
                <thead><tr><th class="rank">#</th><th>Spieler</th><th>MVP</th></tr></thead>
                <tbody id="tbl-mvp"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PLAYER STATS -->
    <section id="tab-player" class="hidden">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>Filter</h2>
            <span class="pill">PowerBI-Slicer</span>
          </div>
          <div class="bd">
            <div style="display:grid; gap:12px">
              <div>
                <label for="sel-player">Spieler</label>
                <select id="sel-player"></select>
              </div>
              <div>
                <label for="sel-map">Map</label>
                <select id="sel-map">
                  <option value="">Alle Maps</option>
                </select>
              </div>
              <div class="muted" style="font-weight:800">
                Tipp: Spieler wählen → Cards & Charts aktualisieren automatisch.
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>KPIs</h2>
            <span class="pill" id="player-kpi-pill">lädt…</span>
          </div>
          <div class="bd">
            <div class="kpis" id="kpi-grid"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="hd">
          <h2>Verlauf (Datum)</h2>
          <span class="pill">5 Charts wie im PBIX</span>
        </div>
        <div class="bd">
          <div class="charts">
            <div class="chartBox">
              <p class="chartTitle">Avg Kills</p>
              <canvas id="ch-kills"></canvas>
            </div>
            <div class="chartBox">
              <p class="chartTitle">Durchschnitt deaths</p>
              <canvas id="ch-deaths"></canvas>
            </div>
            <div class="chartBox">
              <p class="chartTitle">Durchschnitt assists</p>
              <canvas id="ch-assists"></canvas>
            </div>
            <div class="chartBox">
              <p class="chartTitle">Durchschnitt KD</p>
              <canvas id="ch-kd"></canvas>
            </div>
            <div class="chartBox">
              <p class="chartTitle">Durchschnitt score</p>
              <canvas id="ch-score"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AUSWERTUNG -->
    <section id="tab-auswertung" class="hidden">
      <div class="card">
        <div class="hd">
          <h2>Auswertung</h2>
          <span class="pill">Platzhalter</span>
        </div>
        <div class="bd">
          <p style="margin:0;font-weight:900;font-size:1.05rem">Hier können wir die PBIX-„Auswertung“ als Web-Seite nachbauen.</p>
          <p class="muted" style="margin-top:10px; font-weight:800; line-height:1.5">
            In deinem PBIX ist diese Seite aktuell hauptsächlich Branding/Text. Wenn du willst,
            ergänzen wir hier später z.B.:
            <br/>• Team-Balance-Statistiken
            <br/>• Map-Heatmap (Beliebtheit + Winrate)
            <br/>• Event-Vergleich (letzte 5 Events)
          </p>
        </div>
      </div>
    </section>

  </div>

  <script>
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const sections = {
      "tab-leaderboard": document.getElementById('tab-leaderboard'),
      "tab-player": document.getElementById('tab-player'),
      "tab-auswertung": document.getElementById('tab-auswertung'),
    };

    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(sections).forEach(k => sections[k].classList.add('hidden'));
        sections[btn.dataset.tab].classList.remove('hidden');
      });
    });

    function fmt(n, digits=1){
      if(n === null || n === undefined || Number.isNaN(n)) return "–";
      return Number(n).toFixed(digits);
    }

    function renderTop3(el, rows, valueKey, suffix=""){
      const pod = (r, idx) => {
        const cls = idx===0 ? "gold" : idx===1 ? "silver" : "bronze";
        return `
          <div class="pod ${cls}">
            <div class="pos">#${idx+1}</div>
            <div class="name">${r.player}</div>
            <div class="metric">${fmt(r[valueKey], 2)}${suffix}</div>
          </div>
        `;
      };
      el.innerHTML = rows.slice(0,3).map(pod).join("");
    }

    function renderTable(bodyEl, rows, valueKey, digits=2){
      bodyEl.innerHTML = rows.map((r,i)=>`
        <tr>
          <td class="rank">${i+1}</td>
          <td>${r.player}</td>
          <td style="text-align:right;font-weight:900">${fmt(r[valueKey], digits)}</td>
        </tr>
      `).join("");
    }

    async function loadLeaderboards(){
      const metrics = [
        {metric:"avg_kills", top3:"top3-avgkills", tbl:"tbl-avgkills", key:"value"},
        {metric:"avg_score", top3:"top3-score", tbl:"tbl-score", key:"value"},
        {metric:"total_kills", top3:"top3-totalkills", tbl:"tbl-totalkills", key:"value"},
        {metric:"mvp_count", top3:"top3-mvp", tbl:"tbl-mvp", key:"value"},
      ];

      for(const m of metrics){
        const res = await fetch(`/api/dashboard/leaderboard?metric=${encodeURIComponent(m.metric)}&limit=20`);
        const data = await res.json();
        const rows = data.rows || [];
        renderTop3(document.getElementById(m.top3), rows, m.key);
        renderTable(document.getElementById(m.tbl), rows, m.key, 2);
      }
    }

    let charts = {};
    function setLineChart(id, labels, values){
      const ctx = document.getElementById(id);
      if(!ctx) return;

      if(charts[id]) charts[id].destroy();

      charts[id] = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '',
            data: values,
            tension: 0.25,
            pointRadius: 2,
            borderWidth: 2,
          }]
        },
        options: {
          responsive:true,
          plugins: { legend: { display:false }},
          scales: {
            x: { ticks: { color: "rgba(242,245,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" }},
            y: { ticks: { color: "rgba(242,245,255,.75)" }, grid: { color: "rgba(255,255,255,.06)" }},
          }
        }
      });
    }

    function renderKpis(summary){
      const items = [
        {label:"Durchschnitt kills", value: fmt(summary.avg_kills,2)},
        {label:"Durchschnitt deaths", value: fmt(summary.avg_deaths,2)},
        {label:"Durchschnitt assists", value: fmt(summary.avg_assists,2)},
        {label:"Durchschnitt KD", value: fmt(summary.avg_kd,2)},
        {label:"Durchschnitt score", value: fmt(summary.avg_score,2)},
        {label:"TotalGames", value: fmt(summary.total_games,0)},
        {label:"Winrate", value: fmt(summary.winrate,1) + "%"},
        {label:"CountMVP", value: fmt(summary.mvp_count,0)},
        {label:"Summe kills", value: fmt(summary.sum_kills,0)},
        {label:"Summe deaths", value: fmt(summary.sum_deaths,0)},
        {label:"Summe assists", value: fmt(summary.sum_assists,0)},
      ];

      const grid = document.getElementById('kpi-grid');
      grid.innerHTML = items.map(it=>`
        <div class="kpi">
          <div class="label">${it.label}</div>
          <div class="value">${it.value}</div>
        </div>
      `).join("");
    }

    async function refreshPlayerStats(){
      const player = document.getElementById('sel-player').value;
      const map = document.getElementById('sel-map').value;

      const pill = document.getElementById('player-kpi-pill');
      pill.textContent = "lädt…";

      const q = new URLSearchParams({ player, map });

      const resSum = await fetch(`/api/dashboard/player-summary?${q.toString()}`);
      const sum = await resSum.json();
      renderKpis(sum);

      pill.textContent = map ? `Map: ${map}` : "Alle Maps";

      // 5 Timeseries wie im PBIX
      const metrics = [
        {metric:"avg_kills", chart:"ch-kills"},
        {metric:"avg_deaths", chart:"ch-deaths"},
        {metric:"avg_assists", chart:"ch-assists"},
        {metric:"avg_kd", chart:"ch-kd"},
        {metric:"avg_score", chart:"ch-score"},
      ];

      for(const m of metrics){
        const res = await fetch(`/api/dashboard/player-series?${q.toString()}&metric=${encodeURIComponent(m.metric)}`);
        const data = await res.json();
        setLineChart(m.chart, data.labels || [], data.values || []);
      }
    }

    async function loadFilters(){
      const res = await fetch('/api/dashboard/filters');
      const data = await res.json();

      const players = data.players || [];
      const maps = data.maps || [];

      const selP = document.getElementById('sel-player');
      selP.innerHTML = players.map(p=>`<option value="${p}">${p}</option>`).join("");

      const selM = document.getElementById('sel-map');
      selM.innerHTML = `<option value="">Alle Maps</option>` + maps.map(m=>`<option value="${m}">${m}</option>`).join("");

      if(players.length){
        document.getElementById('sel-player').value = players[0];
      }

      document.getElementById('data-pill').textContent = `Spieler: ${players.length} · Maps: ${maps.length}`;
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadFilters();
      await loadLeaderboards();
      await refreshPlayerStats();

      document.getElementById('sel-player').addEventListener('change', refreshPlayerStats);
      document.getElementById('sel-map').addEventListener('change', refreshPlayerStats);
    });
  </script>
</body>
</html>
