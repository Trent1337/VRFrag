<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VRFrag Event Manager</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#242834;
      --bg-2:#1f2230;
      --surface:rgba(255,255,255,.06);
      --surface-2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.12);
      --text:#f2f5ff;
      --muted:rgba(242,245,255,.72);
      --primary:#2f9bff;
      --primary-2:#3a7cff;
      --purple:#7c3aed;
      --gold:#fcd712;
      --success:#22c55e;
      --danger:#ef4444;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(47,155,255,.25), transparent 55%),
                  radial-gradient(900px 420px at 85% 10%, rgba(124,58,237,.22), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }

    .shell{max-width:1050px;margin:0 auto}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom:18px;
      gap:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(47,155,255,.95), rgba(124,58,237,.9));
      display:grid;place-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.15);
    }
    .logo i{color:white}
    .brand h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    .brand p{margin:2px 0 0 0;color:var(--muted);font-size:.9rem}
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background:rgba(255,255,255,.05);
      font-size:.9rem;
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding:18px 18px 14px 18px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .card-hd h2{
      margin:0; font-size:1.0rem; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .card-hd h2 i{color:rgba(242,245,255,.9)}
    .card-bd{padding:18px}

    .help{color:var(--muted); font-size:.92rem; line-height:1.5; margin:0}

    label{display:block; font-weight:600; margin:0 0 8px 0; color:rgba(242,245,255,.9)}
    .field{position:relative}
    .field i{
      position:absolute; left:14px; top:50%; transform:translateY(-50%);
      color:rgba(242,245,255,.55);
      pointer-events:none;
    }
    input[type="url"], input[type="text"]{
      width:100%;
      padding:14px 14px 14px 44px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      transition: border-color .2s, box-shadow .2s, background .2s;
    }
    input[type="text"]{padding-left:14px}
    input:focus{
      border-color: rgba(47,155,255,.55);
      box-shadow: 0 0 0 4px rgba(47,155,255,.18);
      background:rgba(0,0,0,.32);
    }
    small{color:var(--muted)}

    .btn{
      width:100%;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      transition: transform .08s, background .2s, border-color .2s;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .btn-primary{
      border-color: transparent;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 16px 35px rgba(47,155,255,.18);
    }
    .btn-primary:hover{background: linear-gradient(135deg, #46b2ff, var(--primary-2))}
    .btn-success{
      border-color: transparent;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 16px 35px rgba(34,197,94,.15);
      width:auto;
      padding:12px 18px;
    }
    .btn-purple{
      border-color: transparent;
      background: linear-gradient(135deg, var(--purple), #5b21b6);
      box-shadow: 0 16px 35px rgba(124,58,237,.16);
    }
    .btn-link{
      width:auto;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
    }

    .loading{display:none; text-align:center; padding:16px}
    .spinner{
      width:46px;height:46px;border-radius:50%;
      border:5px solid rgba(255,255,255,.14);
      border-top-color: var(--primary);
      animation:spin 1s linear infinite;
      margin:0 auto 12px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .alert{
      display:none;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      margin:14px 0 0 0;
      background:rgba(0,0,0,.22);
      line-height:1.45;
    }
    .alert-success{border-color: rgba(34,197,94,.35)}
    .alert-success i{color: var(--success)}
    .alert-error{border-color: rgba(239,68,68,.35)}
    .alert-error i{color: var(--danger)}
    .github-link{color:var(--text); text-decoration:none}
    .github-link:hover{text-decoration:underline}

    .results-section{display:none}
    .players-grid{display:grid; gap:12px; margin-top:14px}
    .player-card{
      display:flex; align-items:center; gap:12px;
      padding:14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(0,0,0,.22);
    }
    .player-avatar{
      width:42px;height:42px;border-radius:14px;
      background: rgba(47,155,255,.12);
      border:1px solid rgba(47,155,255,.22);
      display:grid; place-items:center;
      font-weight:800;
      color: rgba(242,245,255,.95);
    }
    .player-info{flex:1; min-width: 140px}
    .player-nickname{font-weight:800}
    .player-input{min-width: 240px; width:100%}
    .player-input input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
    }

    .save-row{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-top:14px; padding-top:14px;
      border-top:1px solid var(--border);
    }

    .stack{display:grid; gap:16px}

    .teaser{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px;
      border-radius: var(--radius);
      border:1px solid rgba(124,58,237,.25);
      background: radial-gradient(700px 240px at 10% 0%, rgba(124,58,237,.22), transparent 55%),
                  rgba(0,0,0,.22);
    }
    .teaser h3{margin:0; font-size:1rem}
    .teaser p{margin:6px 0 0 0; color:var(--muted); font-size:.92rem}

    footer{
      margin-top:18px;
      color:rgba(242,245,255,.55);
      font-size:.9rem;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><i class="fa-solid fa-gamepad"></i></div>
        <div>
          <h1>VRFrag Event Manager</h1>
          <p>Spieler abrufen, Namen zuordnen und Statistiken aktualisieren</p>
        </div>
      </div>
      <div class="badge"><i class="fa-solid fa-shield-halved"></i> JT </div>
    </header>

    <div class="grid">
      <!-- LEFT: Event + Spieler -->
      <section class="card">
        <div class="card-hd">
          <h2><i class="fa-solid fa-plus-circle"></i> Event erfassen</h2>
          <a class="btn btn-link" href="/teams"><i class="fa-solid fa-users"></i> Team-Generator</a>
        </div>
        <div class="card-bd">
          <div style="display:grid; gap:12px;">
            <div>
              <label for="gameLink">VRFrag Spiel-Link</label>
              <div class="field">
                <i class="fa-solid fa-globe"></i>
                <input type="url" id="gameLink" placeholder="https://www.vrfrag.com/stats?abc123" />
              </div>
            </div>

            <button id="fetchPlayers" class="btn btn-primary" onclick="fetchPlayers()">
              <i class="fa-solid fa-users"></i> Spieler automatisch abrufen
            </button>

            <div id="loading" class="loading">
              <div class="spinner"></div>
              <div style="color:var(--muted)">Spieler werden von VRFrag abgerufen‚Ä¶</div>
            </div>

            <div id="error" class="alert alert-error"></div>
            <div id="success" class="alert alert-success"></div>

            <div id="results" class="results-section">
              <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-top:4px">
                <div>
                  <h2 style="margin:0; font-size:1rem; display:flex; gap:10px; align-items:center">
                    <i class="fa-solid fa-list-check"></i> Gefundene Spieler
                  </h2>
                  <p class="help" style="margin-top:6px">Trage die echten Namen ein. Vorschl√§ge werden angezeigt, wenn verf√ºgbar.</p>
                </div>

                <div style="min-width:260px; width:100%">
                  <label for="filename">Dateiname (optional)</label>
                  <input type="text" id="filename" placeholder="z.B. 2025_05_23_01" />
                  <small>Leer lassen f√ºr automatische Generierung (YYYY_MM_DD_NN.txt)</small>
                </div>
              </div>

              <div id="playersList" class="players-grid"></div>

              <div class="save-row">
                <button id="saveToGitHub" class="btn btn-success" onclick="saveToGitHub()">
                  <i class="fab fa-github"></i> Speichern
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Stats -->
      <div class="stack">
        <section class="card">
          <div class="card-hd">
            <h2><i class="fa-solid fa-chart-column"></i> Statistiken</h2>
            <span class="badge"><i class="fa-solid fa-bolt"></i> CSV-Export</span>
          </div>
          <div class="card-bd">
            <p class="help">Generiere und aktualisiere die Statistiken aus allen gespeicherten Events.</p>

            <div style="margin-top:14px;">
              <button id="updateStats" class="btn btn-purple" onclick="updateStatistics()">
                <i class="fa-solid fa-rotate"></i> Statistiken aktualisieren
              </button>
              <a href="/dashboard" class="btn primary" style="width:100%; margin-top:10px;">
                üìä Dashboard √∂ffnen
              </a>

            </div>

            <div id="statsLoading" class="loading" style="display:none">
              <div class="spinner"></div>
              <div style="color:var(--muted)">Statistiken werden generiert‚Ä¶</div>
            </div>

            <div id="statsResults" class="card" style="display:none; margin-top:14px; background:rgba(0,0,0,.22); box-shadow:none">
              <div class="card-bd">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px">
                  <i class="fa-solid fa-check-circle" style="color:var(--success)"></i>
                  <strong>Statistiken erfolgreich generiert</strong>
                </div>
                <div id="statsDetails"></div>
                <div id="fileLinks" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-hd">
            <h2><i class="fa-solid fa-users"></i> Fair Team Generator</h2>
          </div>
          <div class="card-bd">
            <div class="teaser">
              <div>
                <h3>Teams fair aufteilen</h3>
                <p>Basierend auf historischen Scores & Performance ‚Äì optional pro Map.</p>
              </div>
              <a href="/teams" class="btn btn-link"><i class="fa-solid fa-rocket"></i> √ñffnen</a>
            </div>
          </div>
        </section>
      </div>
    </div>

    <footer>¬© <span id="y"></span> JT </footer>
  </div>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
  </script>

  <!-- FUNKTIONEN BLEIBEN: (dein bestehendes JS, nur optisch "neue H√ºlle") -->
  <script>
        let currentPlayers = [];

        function fetchPlayers() {
            const gameLink = document.getElementById('gameLink').value;
            const button = document.getElementById('fetchPlayers');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            if (!gameLink) { showError('Bitte geben Sie einen g√ºltigen VRFrag Link ein.'); return; }
            if (!gameLink.includes('vrfrag.com/stats?')) { showError('Bitte geben Sie einen g√ºltigen VRFrag Stats-Link ein.'); return; }

            hideAlerts();
            results.style.display = 'none';
            button.disabled = true;
            loading.style.display = 'block';
            currentPlayers = [];

            fetch('/api/get-players', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ game_link: gameLink })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                button.disabled = false;

                if (data.success) {
                    currentPlayers = data.players;
                    displayPlayers(data.players);
                    showSuccess(`‚úÖ Erfolgreich ${data.players.length} Spieler gefunden!`);
                    results.style.display = 'block';
                } else {
                    showError(data.error || 'Ein Fehler ist aufgetreten.');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                button.disabled = false;
                showError('Fehler beim Abrufen der Daten: ' + error.message);
            });
        }

        function displayPlayers(players) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            players.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.innerHTML = `
                  <div class="player-avatar">${index + 1}</div>
                  <div class="player-info"><div class="player-nickname">${player}</div></div>
                  <div class="player-input">
                      <input type="text"
                             id="input_${index}"
                             placeholder="Echten Namen eingeben..."
                             oninput="validateInput(this)" />
                      <div class="name-suggest" id="suggest_${index}" style="margin-top:8px; font-size:0.92rem; color: var(--muted);"></div>
                  </div>
                `;
                playersList.appendChild(playerCard);
                loadNameSuggestion(index, player);
            });
        }

        function validateInput(input) {
            if (input.value.trim()) {
                input.style.borderColor = 'rgba(34,197,94,.55)';
                input.style.background = 'rgba(34,197,94,.08)';
            } else {
                input.style.borderColor = 'rgba(255,255,255,.12)';
                input.style.background = 'rgba(0,0,0,.25)';
            }
        }

        function collectMappings() {
            const gameLink = document.getElementById('gameLink').value;
            const mappings = [];
            currentPlayers.forEach((player, index) => {
                const input = document.getElementById(`input_${index}`);
                const realName = input.value.trim();
                if (realName) mappings.push({ nickname: player, realName: realName });
            });
            return { gameLink, mappings };
        }

        function loadNameSuggestion(index, nickname) {
          fetch(`/api/name-suggestions?username=${encodeURIComponent(nickname)}`)
              .then(res => res.json())
              .then(data => {
                  const box = document.getElementById(`suggest_${index}`);
                  if (!box) return;

                  if (!data.success || (!data.best && (!data.others || data.others.length === 0))) {
                      box.innerHTML = '';
                      return;
                  }

                  const best = data.best || '';
                  const others = data.others || [];

                  let html = '';
                  if (best) {
                      html += `Vorschlag: <a href="#" onclick="applySuggestion(${index}, '${escapeQuotes(best)}'); return false;" style="font-weight:700; color: var(--primary); text-decoration:none;">${best}</a>`;
                  }

                  if (others.length) {
                      html += `<div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">` +
                          others.slice(0, 4).map(name =>
                              `<a href="#" onclick="applySuggestion(${index}, '${escapeQuotes(name)}'); return false;"
                                  style="padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:999px; text-decoration:none; color:rgba(242,245,255,.85); background:rgba(0,0,0,.18);">
                                  ${name}
                               </a>`
                          ).join('') +
                          `</div>`;
                  }

                  box.innerHTML = html;
              })
              .catch(() => {});
        }

        function applySuggestion(index, name) {
            const input = document.getElementById(`input_${index}`);
            if (!input) return;
            input.value = name;
            validateInput(input);
        }

        function escapeQuotes(str) {
            return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }

        function saveToGitHub() {
            const { gameLink, mappings } = collectMappings();
            const filename = document.getElementById('filename').value.trim();

            if (mappings.length === 0) { showError('Bitte geben Sie mindestens einen echten Namen ein.'); return; }
            if (mappings.length !== currentPlayers.length) {
                if (!confirm(`Es wurden nur ${mappings.length} von ${currentPlayers.length} Namen ausgef√ºllt. Trotzdem fortfahren?`)) return;
            }

            const saveButton = document.getElementById('saveToGitHub');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Speichere...';
            saveButton.disabled = true;

            const saveData = { game_link: gameLink, mappings: mappings };
            if (filename) saveData.filename = filename;

            fetch('/api/save-to-github', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;

                if (data.success) {
                    let successHtml = `‚úÖ Datei erfolgreich gespeichert: <strong>${data.filename}</strong>`;
                    if (data.html_url) {
                        successHtml += `<br><a href="${data.html_url}" target="_blank" class="github-link">
                            <i class="fab fa-github"></i> Auf GitHub ansehen
                        </a>`;
                    }
                    showSuccess(successHtml);

                    setTimeout(() => {
                        document.getElementById('gameLink').value = '';
                        document.getElementById('filename').value = '';
                        document.getElementById('results').style.display = 'none';
                        currentPlayers.forEach((_, index) => {
                            const input = document.getElementById(`input_${index}`);
                            if (input) input.value = '';
                        });
                    }, 2500);
                } else {
                    showError('‚ùå Fehler: ' + data.error);
                }
            })
            .catch(error => {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
                showError('Netzwerkfehler: ' + error.message);
            });
        }

        function updateStatistics() {
            const button = document.getElementById('updateStats');
            const loading = document.getElementById('statsLoading');
            const results = document.getElementById('statsResults');

            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            results.style.display = 'none';
            button.disabled = true;
            loading.style.display = 'block';

            fetch('/api/update-statistics', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                button.disabled = false;

                if (data.success) {
                    showStatsResults(data);
                } else {
                    showError('Statistiken Fehler: ' + data.error);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                button.disabled = false;
                showError('Netzwerkfehler: ' + error.message);
            });
        }

        function showStatsResults(data) {
            const results = document.getElementById('statsResults');
            const details = document.getElementById('statsDetails');
            const fileLinks = document.getElementById('fileLinks');

            details.innerHTML = `
                <p><strong>üìä Spieler Eintr√§ge:</strong> ${data.player_count}</p>
                <p><strong>üéØ Match Eintr√§ge:</strong> ${data.match_count}</p>
                <p><strong>üë• Einzigartige Spieler:</strong> ${data.unique_players}</p>
                <p><strong>‚è∞ Generiert am:</strong> ${new Date().toLocaleString('de-DE')}</p>
            `;

            fileLinks.innerHTML = `
                <a href="/files/${data.players_file}" class="btn btn-link" style="text-decoration:none; width:auto">
                    <i class="fas fa-download"></i> Spieler-Statistiken
                </a>
                <a href="/files/${data.matches_file}" class="btn btn-link" style="text-decoration:none; width:auto">
                    <i class="fas fa-download"></i> Match-Statistiken
                </a>
            `;

            results.style.display = 'block';
            showSuccess('‚úÖ Statistiken erfolgreich aktualisiert!');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        function hideAlerts() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        document.getElementById('gameLink').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') fetchPlayers();
        });

        document.getElementById('filename').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('results').style.display === 'block') saveToGitHub();
            }
        });
  </script>
</body>
</html>
