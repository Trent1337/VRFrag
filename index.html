<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRFrag Spieler Manager</title>
    <style>
        /* Vorherige Styles bleiben gleich, f√ºge hinzu: */
        .filename-input {
            margin: 15px 0;
        }
        .filename-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .download-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .download-buttons button {
            flex: 1;
            padding: 10px;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>VRFrag Spieler Manager</h1>
        
        <div class="input-group">
            <label for="gameLink">VRFrag Spiel-Link:</label>
            <input type="url" id="gameLink" placeholder="https://www.vrfrag.com/stats?abc123" />
        </div>
        
        <button id="fetchPlayers" onclick="fetchPlayers()">Spieler automatisch abrufen</button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Spieler werden von VRFrag abgerufen...</p>
        </div>
        
        <div id="error" class="error"></div>
        <div id="success" class="success"></div>
        
        <div id="results" class="results">
            <h2>Gefundene Spieler-Nicknames</h2>
            
            <div class="filename-input">
                <label for="filename">Dateiname (optional):</label>
                <input type="text" id="filename" placeholder="z.B. 2025_05_23_01" />
                <small>Leer lassen f√ºr automatische Generierung (YYYY_MM_DD_NN.txt)</small>
            </div>
            
            <div id="playersList"></div>
            
            <div class="download-buttons">
                <button id="saveMappings" onclick="saveMappings()" class="btn-primary">üìÅ Im events Ordner speichern</button>
                <button id="downloadFile" onclick="downloadFile()" class="btn-secondary">‚¨áÔ∏è Datei herunterladen</button>
            </div>
        </div>
    </div>

    <script>
        let currentMappings = [];

        function fetchPlayers() {
            // Vorherige Implementierung bleibt gleich
            const gameLink = document.getElementById('gameLink').value;
            const button = document.getElementById('fetchPlayers');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            const results = document.getElementById('results');
            
            if (!gameLink) {
                showError('Bitte geben Sie einen g√ºltigen VRFrag Link ein.');
                return;
            }
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            results.style.display = 'none';
            button.disabled = true;
            loading.style.display = 'block';
            
            fetch('/api/get-players', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ game_link: gameLink })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                button.disabled = false;
                
                if (data.success) {
                    displayPlayers(data.players);
                    successDiv.textContent = `‚úÖ Erfolgreich ${data.players.length} Spieler gefunden!`;
                    successDiv.style.display = 'block';
                } else {
                    showError(data.error || 'Ein Fehler ist aufgetreten.');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                button.disabled = false;
                showError('Fehler beim Abrufen der Daten: ' + error.message);
            });
        }
        
        function displayPlayers(players) {
            const playersList = document.getElementById('playersList');
            const results = document.getElementById('results');
            
            playersList.innerHTML = '';
            
            players.forEach((player, index) => {
                const playerRow = document.createElement('div');
                playerRow.className = 'player-row';
                playerRow.innerHTML = `
                    <div class="nickname">${player}</div>
                    <div class="input-field">
                        <input type="text" id="input_${index}" placeholder="Echter Name f√ºr ${player}" />
                    </div>
                `;
                playersList.appendChild(playerRow);
            });
            
            results.style.display = 'block';
        }
        
        function collectMappings() {
            const playersList = document.getElementById('playersList');
            const inputs = playersList.querySelectorAll('input[type="text"]');
            const gameLink = document.getElementById('gameLink').value;
            const mappings = [];
            
            inputs.forEach((input, index) => {
                const realName = input.value.trim();
                if (realName) {
                    const nickname = input.placeholder.replace('Echter Name f√ºr ', '');
                    mappings.push({
                        nickname: nickname,
                        realName: realName
                    });
                }
            });
            
            return { gameLink, mappings };
        }
        
        function saveMappings() {
            const { gameLink, mappings } = collectMappings();
            const filename = document.getElementById('filename').value.trim();
            
            if (mappings.length === 0) {
                showError('Bitte geben Sie mindestens einen echten Namen ein.');
                return;
            }
            
            const saveData = {
                game_link: gameLink,
                mappings: mappings
            };
            
            if (filename) {
                saveData.filename = filename;
            }
            
            fetch('/api/save-event-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(`‚úÖ Event-Datei gespeichert als: ${data.filename}`);
                    currentMappings = mappings;
                } else {
                    showError('Fehler beim Speichern: ' + data.error);
                }
            })
            .catch(error => {
                showError('Fehler: ' + error.message);
            });
        }
        
        function downloadFile() {
            const { gameLink, mappings } = collectMappings();
            
            if (mappings.length === 0) {
                showError('Bitte geben Sie mindestens einen echten Namen ein.');
                return;
            }
            
            // Event-Datei Inhalt erstellen
            let fileContent = gameLink + '\n';
            mappings.forEach(mapping => {
                fileContent += `${mapping.nickname}=${mapping.realName}\n`;
            });
            
            // Datei-Download
            const blob = new Blob([fileContent], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Dateinamen setzen
            const filenameInput = document.getElementById('filename').value.trim();
            if (filenameInput) {
                a.download = filenameInput.endsWith('.txt') ? filenameInput : filenameInput + '.txt';
            } else {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '_');
                a.download = `${today}_01.txt`;
            }
            
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccess('‚úÖ Datei heruntergeladen!');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        document.getElementById('gameLink').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchPlayers();
            }
        });
    </script>
</body>
</html>
